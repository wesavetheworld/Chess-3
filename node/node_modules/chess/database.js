var fs = require("fs");
var sqlite3 = require("sqlite3").verbose();

var dbName = "chess_db";
var db;

var tdb = module.exports = new Database();

//==================================
//  Class
//==================================
function Database() {

}

Database.prototype.userExists = function(user, password, callback) {
    db.get("SELECT id FROM users WHERE user='"+user+"' AND password='"+password+"'", function(err, row) {
        if(err) throw err;
        var id = null;
        if(row != null) {
            id = row.id;
        }
        if(callback != null)
            callback(row != null, id);
    });
};

Database.prototype.addNewUser = function(user, password, callback) {
    db.get("SELECT id, user FROM users WHERE user='"+user+"'", function(err, row) {
        if(err) throw err;
        if(row == null) {
            db.run("INSERT INTO users (id, user, password) VALUES(?,?,?)", [null, user, password]);
            callback(this, true);
        } else {
            callback(this, false);
        }
    });
};

Database.prototype.traceAllUsers = function() {
    db.each("SELECT id, user, password FROM users", function(err, row) {
        if(err) throw err;
        console.log("User:[" + row.id + ", " + row.user + ", " + row.password + "]");
    });
};

//==================================
//  Internal Functions
//==================================
fs.exists(dbName, function(exists) {
    if(exists) {
        console.log(" - Database [" + dbName + "] found.");
        db = new sqlite3.Database(dbName);
        tdb.traceAllUsers();
    } else {
        console.log(" - Database [" + dbName + "] not found.");
        console.log(" - Creating new database [" + dbName + "]...");

        fs.readFile("create.sql", "utf8", function(err, data) {
            db = new sqlite3.Database(dbName);
            db.exec(data, function(err) {
                if(err) throw err;
                console.log(" - Database [" + dbName + "] created.");
            });
        });
    }
});